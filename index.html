<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Hour Tracker</title>
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --tertiary-bg: #e9ecef;
            --primary-text: #212529;
            --secondary-text: #495057;
            --accent-color: #007bff;
            --accent-text: #ffffff;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        html[data-theme='dark'] {
            --primary-bg: #212529;
            --secondary-bg: #343a40;
            --tertiary-bg: #495057;
            --primary-text: #f8f9fa;
            --secondary-text: #adb5bd;
            --accent-color: #0d6efd;
            --accent-text: #ffffff;
            --danger-color: #fd7e14;
            --success-color: #198754;
            --warning-color: #ffca2c;
            --border-color: #495057;
            --shadow-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        h1, h2, h3 {
            color: var(--primary-text);
            margin-top: 0;
        }
        h1 { text-align: center; margin-bottom: 20px; }
        h2 { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;}

        /* Utility Classes */
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--tertiary-bg);
            border-radius: 5px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-text); }
        input[type="date"],
        input[type="time"],
        input[type="number"],
        input[type="text"],
        textarea {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--secondary-bg);
            color: var(--primary-text);
            font-size: 1rem;
        }
        textarea { resize: vertical; }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--accent-text);
            background-color: var(--accent-color);
            transition: background-color 0.2s;
            margin-right: 5px;
        }
        button:hover { filter: brightness(90%); }
        button.danger { background-color: var(--danger-color); }
        button.success { background-color: var(--success-color); }
        button.warning { background-color: var(--warning-color); color: #333;}
        button:disabled { background-color: var(--secondary-text); cursor: not-allowed;}

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;}
        #themeToggle { font-size: 0.8rem; padding: 5px 10px; }

        /* Timer Section */
        .timer-display { font-size: 1.5rem; font-weight: bold; margin: 10px 0; text-align: center; }
        .timer-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;}

        /* Entries Table */
        #entriesTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #entriesTable th, #entriesTable td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        #entriesTable th { background-color: var(--tertiary-bg); font-weight: bold; }
        #entriesTable td .description { font-size: 0.9em; color: var(--secondary-text); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block;}
        #entriesTable .actions button { padding: 5px 8px; font-size: 0.8rem; margin-right: 3px;}

        /* Filters and Reporting */
        .filter-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;}
        .totals-display p { font-size: 1.1em; font-weight: bold; margin: 5px 0;}
        #totalHoursFiltered, #totalPayFiltered { color: var(--success-color); }

        /* Export Section */
        #csvOutput {
            width: calc(100% - 20px);
            min-height: 100px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            background-color: var(--primary-bg);
            border: 1px dashed var(--border-color);
            padding: 10px;
        }

        /* Modal (for editing) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: var(--secondary-bg);
            margin: 10% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .modal-close {
            color: var(--secondary-text);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: var(--primary-text); text-decoration: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-group { flex-direction: column; align-items: stretch; }
            #entriesTable th, #entriesTable td { padding: 8px; }
            #entriesTable .description { max-width: 100px; }
            .modal-content { width: 90%; margin: 20% auto;}
        }
         @media (max-width: 480px) {
             #entriesTable { display: block; overflow-x: auto; white-space: nowrap;}
             h1 { font-size: 1.8rem;}
             .section { padding: 15px;}
             button { padding: 8px 12px; font-size: 0.9rem;}
             #entriesTable .actions button { padding: 4px 6px; font-size: 0.7rem;}
         }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Advanced Hour Tracker</h1>
            <button id="themeToggle">Toggle Theme</button>
        </div>

        <div class="section">
            <h2>Settings</h2>
            <div class="form-group">
                <label for="hourlyRate">Default Hourly Rate ($):</label>
                <input type="number" id="hourlyRate" step="0.01" placeholder="e.g., 25.50">
            </div>
            <button id="saveSettingsBtn" class="success">Save Settings</button>
        </div>

        <div class="section">
            <h2>Log Time</h2>
            <div class="timer-controls">
                <button id="startTimerBtn" class="success">Start Timer</button>
                <button id="stopTimerBtn" class="danger" disabled>Stop Timer</button>
            </div>
            <div id="timerDisplay" class="timer-display">00:00:00</div>
             <input type="hidden" id="timerStartTime"> <hr style="margin: 20px 0; border-color: var(--border-color);">

            <h3>Manual Entry / Edit</h3>
            <input type="hidden" id="editEntryId"> <div class="form-group">
                <label for="entryDate">Date:</label>
                <input type="date" id="entryDate">
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1;">
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="endTime">End Time:</label>
                    <input type="time" id="endTime">
                </div>
            </div>
             <div class="form-group">
                <label for="description">Description (Optional):</label>
                <input type="text" id="description" placeholder="Task performed, client, etc.">
            </div>
            <button id="addEntryBtn">Add Manual Entry</button>
            <button id="updateEntryBtn" style="display: none;" class="warning">Update Entry</button>
            <button id="cancelEditBtn" style="display: none;">Cancel Edit</button>
        </div>

         <div class="section">
             <h2>History & Entries</h2>
             <div class="filter-group">
                 <div class="form-group">
                     <label for="filterStartDate">From:</label>
                     <input type="date" id="filterStartDate">
                 </div>
                 <div class="form-group">
                     <label for="filterEndDate">To:</label>
                     <input type="date" id="filterEndDate">
                 </div>
                 <button id="filterBtn">Apply Filter</button>
                 <button id="resetFilterBtn">Reset Filter</button>
             </div>
             <div class="totals-display">
                 <h3>Filtered Totals</h3>
                 <p>Total Hours: <span id="totalHoursFiltered">0.00</span></p>
                 <p>Total Pay: $<span id="totalPayFiltered">0.00</span></p>
             </div>
             <table id="entriesTable">
                 <thead>
                     <tr>
                         <th>Date</th>
                         <th>Start</th>
                         <th>End</th>
                         <th>Duration (hrs)</th>
                         <th>Description</th>
                         <th>Pay ($)</th>
                         <th>Actions</th>
                     </tr>
                 </thead>
                 <tbody id="entriesTbody">
                     </tbody>
             </table>
         </div>

         <div class="section">
             <h2>Export Data</h2>
             <button id="exportCsvBtn">Generate CSV for Filtered Entries</button>
             <textarea id="csvOutput" readonly placeholder="CSV data will appear here. Copy and paste into a text file or spreadsheet."></textarea>
         </div>

    </div> <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" id="modalCloseBtn">&times;</span>
        <h2>Edit Entry</h2>
        <p>Please use the "Manual Entry / Edit" form above to modify the details and click "Update Entry".</p>
      </div>
    </div>


    <script>
        // ---=== Polyfills & Helpers ===---
        // Basic unique ID generator
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // Format seconds into HH:MM:SS
        const formatTime = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return [hours, minutes, secs].map(v => v < 10 ? "0" + v : v).join(":");
        };

        // Format date string YYYY-MM-DD to readable format
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            const dateObj = new Date(year, month - 1, day); // Month is 0-indexed
            return dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
        };


        // ---=== DOM Elements ===---
        const themeToggle = document.getElementById('themeToggle');
        const hourlyRateInput = document.getElementById('hourlyRate');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const entryDateInput = document.getElementById('entryDate');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const descriptionInput = document.getElementById('description');
        const addEntryBtn = document.getElementById('addEntryBtn');
        const updateEntryBtn = document.getElementById('updateEntryBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editEntryIdInput = document.getElementById('editEntryId');
        const entriesTbody = document.getElementById('entriesTbody');
        const filterStartDateInput = document.getElementById('filterStartDate');
        const filterEndDateInput = document.getElementById('filterEndDate');
        const filterBtn = document.getElementById('filterBtn');
        const resetFilterBtn = document.getElementById('resetFilterBtn');
        const totalHoursFilteredSpan = document.getElementById('totalHoursFiltered');
        const totalPayFilteredSpan = document.getElementById('totalPayFiltered');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const csvOutput = document.getElementById('csvOutput');
        // Timer elements
        const startTimerBtn = document.getElementById('startTimerBtn');
        const stopTimerBtn = document.getElementById('stopTimerBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStartTimeInput = document.getElementById('timerStartTime');
        // Modal elements (though only using it conceptually here)
        // const editModal = document.getElementById('editModal');
        // const modalCloseBtn = document.getElementById('modalCloseBtn');


        // ---=== State Variables ===---
        let entries = [];
        let settings = { hourlyRate: 25.00, theme: 'light' }; // Default settings
        let currentFilter = { startDate: null, endDate: null };
        let timerInterval = null;
        let timerSeconds = 0;

        // ---=== localStorage Keys ===---
        const ENTRIES_STORAGE_KEY = 'advTimeTrackerEntries';
        const SETTINGS_STORAGE_KEY = 'advTimeTrackerSettings';

        // ---=== Core Logic Functions ===---

        // Load data from localStorage
        const loadData = () => {
            const storedEntries = localStorage.getItem(ENTRIES_STORAGE_KEY);
            const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);

            if (storedEntries) {
                try { entries = JSON.parse(storedEntries); } catch (e) { console.error("Error parsing entries:", e); entries = []; }
            } else {
                entries = [];
            }

            if (storedSettings) {
                try { settings = JSON.parse(storedSettings); } catch (e) { console.error("Error parsing settings:", e); /* Keep defaults */ }
            }
            // Apply loaded settings
            hourlyRateInput.value = settings.hourlyRate || 25.00;
            document.documentElement.setAttribute('data-theme', settings.theme || 'light');
            themeToggle.textContent = settings.theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        };

        // Save data to localStorage
        const saveData = () => {
            try {
                localStorage.setItem(ENTRIES_STORAGE_KEY, JSON.stringify(entries));
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                alert("Could not save data. LocalStorage might be full or disabled.");
            }
        };

        // Calculate duration between two time strings in hours
        const calculateDuration = (start, end) => {
            if (!start || !end) return 0;
            const startDate = new Date(`1970-01-01T${start}:00`);
            const endDate = new Date(`1970-01-01T${end}:00`);
            if (isNaN(startDate) || isNaN(endDate)) return 0; // Invalid time format

            if (endDate <= startDate) { // Handle overnight
                endDate.setDate(endDate.getDate() + 1);
            }
            const diffMs = endDate - startDate;
            return diffMs / (1000 * 60 * 60);
        };

        // Render the entries table based on current filter
        const renderEntries = () => {
            entriesTbody.innerHTML = ''; // Clear table
            let filteredEntries = entries;

            // Apply date filter
            if (currentFilter.startDate) {
                filteredEntries = filteredEntries.filter(e => e.date >= currentFilter.startDate);
            }
            if (currentFilter.endDate) {
                filteredEntries = filteredEntries.filter(e => e.date <= currentFilter.endDate);
            }

            // Sort by date descending (most recent first)
            filteredEntries.sort((a, b) => new Date(b.date + 'T' + b.startTime) - new Date(a.date + 'T' + a.startTime));

            let totalHours = 0;
            let totalPay = 0;
            const rate = parseFloat(settings.hourlyRate) || 0;

            if (filteredEntries.length === 0) {
                 entriesTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--secondary-text);">No entries found for the selected period.</td></tr>';
             } else {
                filteredEntries.forEach(entry => {
                    const duration = calculateDuration(entry.startTime, entry.endTime);
                    const pay = duration * rate;
                    totalHours += duration;
                    totalPay += pay;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.startTime}</td>
                        <td>${entry.endTime}</td>
                        <td>${duration.toFixed(2)}</td>
                        <td><span class="description" title="${entry.description || ''}">${entry.description || '-'}</span></td>
                        <td>${pay.toFixed(2)}</td>
                        <td class="actions">
                            <button class="warning edit-btn" data-id="${entry.id}">Edit</button>
                            <button class="danger delete-btn" data-id="${entry.id}">Del</button>
                        </td>
                    `;
                    entriesTbody.appendChild(tr);
                });
            }

            // Update filtered totals display
            totalHoursFilteredSpan.textContent = totalHours.toFixed(2);
            totalPayFilteredSpan.textContent = totalPay.toFixed(2);

            // Add event listeners for edit/delete buttons
            attachActionListeners();
        };

        // Attach listeners to dynamically created buttons
        const attachActionListeners = () => {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEdit);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
        };

        // Clear input form
        const clearForm = () => {
            editEntryIdInput.value = ''; // Clear edit ID
            entryDateInput.value = new Date().toISOString().split('T')[0]; // Reset date
            startTimeInput.value = '';
            endTimeInput.value = '';
            descriptionInput.value = '';
            addEntryBtn.style.display = 'inline-block';
            updateEntryBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            startTimeInput.disabled = false;
            endTimeInput.disabled = false;
            entryDateInput.disabled = false;
        };

        // ---=== Event Handlers ===---
        const handleSaveSettings = () => {
            const rate = parseFloat(hourlyRateInput.value);
            if (isNaN(rate) || rate < 0) {
                alert("Please enter a valid non-negative hourly rate.");
                return;
            }
            settings.hourlyRate = rate.toFixed(2); // Store as string with 2 decimals
            saveData();
            renderEntries(); // Re-render in case pay changed
            alert("Settings saved!");
        };

        const handleAddEntry = () => {
            const date = entryDateInput.value;
            const start = startTimeInput.value;
            const end = endTimeInput.value;
            const description = descriptionInput.value.trim();
            const rate = parseFloat(settings.hourlyRate) || 0;

            if (!date || !start || !end) {
                alert("Please fill in Date, Start Time, and End Time.");
                return;
            }
             if (end < start) {
                 if (!confirm("End time is before start time. Is this an overnight shift?")) {
                     return; // Don't add if user cancels
                 }
             }

            const newEntry = {
                id: generateId(),
                date,
                startTime: start,
                endTime: end,
                description,
                hourlyRate: rate // Store rate at time of entry (optional)
            };
            entries.push(newEntry);
            saveData();
            renderEntries();
            clearForm();
        };

         // Handle clicking the Edit button on a row
         const handleEdit = (event) => {
             const id = event.target.getAttribute('data-id');
             const entryToEdit = entries.find(e => e.id === id);
             if (!entryToEdit) return;

             // Populate the form
             editEntryIdInput.value = entryToEdit.id;
             entryDateInput.value = entryToEdit.date;
             startTimeInput.value = entryToEdit.startTime;
             endTimeInput.value = entryToEdit.endTime;
             descriptionInput.value = entryToEdit.description || '';

             // Change button visibility
             addEntryBtn.style.display = 'none';
             updateEntryBtn.style.display = 'inline-block';
             cancelEditBtn.style.display = 'inline-block';

             // Scroll to form and maybe highlight it
             startTimeInput.focus();
             document.getElementById('startTime').closest('.section').scrollIntoView({ behavior: 'smooth' });

             // // Optional: Show a modal instead of reusing the form
             // // modalContent.innerHTML = '... form fields populated ...';
             // // editModal.style.display = 'block';
         };

         // Handle clicking the Update Entry button (after populating form via Edit)
         const handleUpdateEntry = () => {
             const id = editEntryIdInput.value;
             const entryIndex = entries.findIndex(e => e.id === id);
             if (entryIndex === -1) return; // Should not happen

             const date = entryDateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;
             const description = descriptionInput.value.trim();

             if (!date || !start || !end) {
                 alert("Please fill in Date, Start Time, and End Time.");
                 return;
             }
             if (end < start) {
                 if (!confirm("End time is before start time. Is this an overnight shift?")) {
                     return; // Don't update if user cancels
                 }
             }

             // Update the entry in the array
             entries[entryIndex] = {
                 ...entries[entryIndex], // Keep original ID and rate
                 date,
                 startTime: start,
                 endTime: end,
                 description
             };

             saveData();
             renderEntries();
             clearForm(); // Resets buttons and clears form
         };

        // Handle clicking the Delete button on a row
        const handleDelete = (event) => {
            const id = event.target.getAttribute('data-id');
            if (confirm(`Are you sure you want to delete this entry?`)) {
                entries = entries.filter(e => e.id !== id);
                saveData();
                renderEntries();
            }
        };

        // Handle filter application
        const handleFilter = () => {
            currentFilter.startDate = filterStartDateInput.value || null;
            currentFilter.endDate = filterEndDateInput.value || null;
            renderEntries(); // Re-render with new filter
            csvOutput.value = ''; // Clear CSV output on new filter
        };

        // Handle filter reset
        const handleResetFilter = () => {
            filterStartDateInput.value = '';
            filterEndDateInput.value = '';
            currentFilter.startDate = null;
            currentFilter.endDate = null;
            renderEntries();
            csvOutput.value = '';
        };

        // Handle exporting filtered data to CSV format
        const handleExportCsv = () => {
            let filteredEntries = entries;
            if (currentFilter.startDate) {
                filteredEntries = filteredEntries.filter(e => e.date >= currentFilter.startDate);
            }
            if (currentFilter.endDate) {
                filteredEntries = filteredEntries.filter(e => e.date <= currentFilter.endDate);
            }

            if (filteredEntries.length === 0) {
                 csvOutput.value = "No entries selected to export.";
                 return;
             }

             const rate = parseFloat(settings.hourlyRate) || 0;
             // Define CSV Header
             let csvContent = "Date,Start Time,End Time,Duration (Hours),Description,Pay ($)\n";

             // Add rows
             filteredEntries.forEach(entry => {
                 const duration = calculateDuration(entry.startTime, entry.endTime);
                 const pay = duration * rate;
                 // Escape commas and quotes in description
                 const escapedDesc = entry.description ? `"${entry.description.replace(/"/g, '""')}"` : '';
                 csvContent += `${entry.date},${entry.startTime},${entry.endTime},${duration.toFixed(3)},${escapedDesc},${pay.toFixed(2)}\n`;
             });

             csvOutput.value = csvContent;
             csvOutput.select(); // Select text for easy copying
             alert("CSV data generated below. Select all (Ctrl+A or Cmd+A) and copy (Ctrl+C or Cmd+C) to paste into a spreadsheet or text file.");
        };

        // Handle theme toggle
        const handleThemeToggle = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            settings.theme = newTheme;
            themeToggle.textContent = newTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            saveData();
        };

         // --- Timer Functionality ---
         const startTimer = () => {
             if (timerInterval) return; // Already running

             // Disable form fields while timer runs maybe? Or just start/end time
             startTimeInput.disabled = true;
             endTimeInput.disabled = true;
             entryDateInput.disabled = true;
             addEntryBtn.disabled = true;

             const now = new Date();
             timerStartTimeInput.value = now.toISOString(); // Store precise start time
             startTimeInput.value = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); // Set start time in form
             entryDateInput.value = now.toISOString().split('T')[0]; // Set date in form

             timerSeconds = 0;
             timerDisplay.textContent = formatTime(timerSeconds);

             timerInterval = setInterval(() => {
                 timerSeconds++;
                 timerDisplay.textContent = formatTime(timerSeconds);
             }, 1000);

             startTimerBtn.disabled = true;
             stopTimerBtn.disabled = false;
         };

         const stopTimer = () => {
             if (!timerInterval) return; // Not running

             clearInterval(timerInterval);
             timerInterval = null;

             const now = new Date();
             endTimeInput.value = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); // Set end time

             startTimerBtn.disabled = false;
             stopTimerBtn.disabled = true;
             addEntryBtn.disabled = false; // Re-enable add button
             startTimeInput.disabled = false; // Re-enable fields
             endTimeInput.disabled = false;
             entryDateInput.disabled = false;


             // Automatically add the entry? Or just pre-fill? Let's pre-fill.
             // User can add description and click "Add Manual Entry"
             alert(`Timer stopped at ${formatTime(timerSeconds)}. Please add description if needed and click 'Add Manual Entry'.`);
             // Optional: Automatically add entry here
             // handleAddEntry();
         };


        // ---=== Initialization ===---
        const initializeApp = () => {
            loadData(); // Load saved data first
            clearForm(); // Set default date and button states
            renderEntries(); // Render initial view

            // Attach persistent event listeners
            saveSettingsBtn.addEventListener('click', handleSaveSettings);
            addEntryBtn.addEventListener('click', handleAddEntry);
            updateEntryBtn.addEventListener('click', handleUpdateEntry);
            cancelEditBtn.addEventListener('click', clearForm);
            filterBtn.addEventListener('click', handleFilter);
            resetFilterBtn.addEventListener('click', handleResetFilter);
            exportCsvBtn.addEventListener('click', handleExportCsv);
            themeToggle.addEventListener('click', handleThemeToggle);
            startTimerBtn.addEventListener('click', startTimer);
            stopTimerBtn.addEventListener('click', stopTimer);

            // // Basic modal close functionality if used
            // modalCloseBtn.addEventListener('click', () => editModal.style.display = "none");
            // window.addEventListener('click', (event) => {
            //     if (event.target == editModal) {
            //         editModal.style.display = "none";
            //     }
            // });
        };

        // Start the application
        initializeApp();

    </script>

</body>
</html>